version: "2"

name: CircleCI snap-in
description: A snap-in to connect CircleCI to DevRev and provide AI insights.


service_account:
  display_name: "CircleCI Sync Bot"


keyrings:
  organization:
    - name: circleci_api_key
      display_name: CircleCI API Key
      description: API Key for CircleCI, follow https://circleci.com/docs/managing-api-tokens/ to know how to get one.
      types:
        - snap_in_secret

    - name: groq_api_key
      display_name: Groq API Key
      description: API Key for using Groq, follow https://console.groq.com/keys to generate a free API Key
      types:
        - snap_in_secret


inputs:
  organization:
    - name: project_slug
      description: The project slug that identifies the project in CircleCI.
      field_type: id
      id_type:
        - product
      is_required: true
      default_value: don:core:dvrv-us-1:devo/XXXXXXX:product/1
      ui:
        display_name: Part Picker


event_sources:
  organization:
    - name: circleci-webhook
      description: Events related to pipeline/workflow/jobs sent on a Webhook connected to CircleCI.
      display_name: CircleCI webhook
      type: flow-custom-webhook
      config:
        policy: |
          package rego
          output = {"event": event, "event_key": event_key} {
            event := input.request.body
            event_key := "circleci.pipeline"
          } else = {"response": response } {
            response := {
            "status_code": 400
            }
          }
        parameters:
          secret: 6aVqEymevGZvkiUk30oWccVLEKNOqkcP
      setup_instructions: "For configuration instructions, refer to the [CircleCI documentation](https://circleci.com/docs/webhooks/). \n\nURL: `{{ source.trigger_url  }}` \n\nSecret: `{{source.config.parameters.secret}}`"


functions:
  - name: generate_insights
    description: Generate insights based on jobId from CircleCI. 

  - name: sync_circleci_data
    description: Sync CircleCI data to DevRev.

automations:
  - name: sync-circleci-webhook
    source: circleci-webhook
    event_types:
      - custom:circleci.pipeline
    function: sync_circleci_data
      

commands:
  - name: generateInsights
    namespace: circleci
    description: Generate insights and recommendations based on CircleCI data.
    surfaces:
      - surface: discussions
        object_types:
          - issue
    usage_hint: "[jobId]"
    function: generate_insights
